# terraform-azure-jmeter-base
Easy way to create jMeter cluster with terraform on your Azure infrastructure and monitor your tests with Grafana
There's a repository of project example in https://github.com/marcoslobo/terraform-azure-jmeter-example

# How to use
1. Create jMeter script (I suggest you to use jMeter UI for that purposes)
2. Generate ssh keys and place them inside ssh folder - e.g. you can use ssh-keygen tool 
  ```
  ssh-keygen -t rsa -C "loadServer" -P '' -f loadServer
  ```
3. Create terraform main.tf - here's example you can use. 

  N.B. Please see variables.tf for full reference on terraform-azure-jmeter-base variables
  ```
provider "azurerm" {
  features {}
}

  module "jmeter_cluster" {
  source = "github.com/marcoslobo/terraform-azure-jmeter-base"
  slave_ssh_public_key_file = "ssh/loadServer.pub"
  master_ssh_private_key_file = "ssh/loadServer"
  master_ssh_public_key_file = "ssh/loadServer.pub"
  jmx_script_file = "script.jmx"
  azure_auth = "my.azureauth"
  prefix = "jmt"
  location = "eastus"
  }  
  ```
4. Install and Login on Azure CLI
5. Create an Enterprise App on Azure and append it to the main subscription (Get clientId, clientSecret, subscriptionId, tenantId)
6. Create the file my.azureauth with informations that you got before

  ```
{
  "clientId": "xxxx",
  "clientSecret": "xxxx",
  "subscriptionId": "xxxx",
  "tenantId": "xxxxx",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}
  ```

7. Use this commands to create infrastructure

  ```
  # terraform get
  # terraform apply
  ```
8. Ssh on master node and start the load test - N.B. You can get master node public ip using `terraform show` command.
  ```
  # ssh -i "loadServer" ubuntu@<MASTER_PUBLIC_IP>
  [ubuntu@<HOSTNAME> ~]$ cd /jmeter-master/
  [ubuntu@<HOSTNAME> jmeter-master]$ dotnet  master_start.py
  ```
  
  N.B. It requires some time to start slave nodes and in case they're didn't for some reason, you can do it manually by SSHing to slave nodes and executing `/apache-jmeter-3.0/bin/jmeter-server` command
9. You can destroy the infrastructure with `terraform destroy`

# How does it work
terraform-aws-jmeter creates one master instance and autoscaling group with jmeter workers. Both master and workers share the same security group which allows all ingress and egress communications inside the group, only ssh ingress connections for other world. It allows egress communications for all ports for outside world as well though to make sure jmeter can access resource it's testing.
Master and workers instances are bootstrapped with jMeter 3 (N.B. only jMeter 3 is currently supported) and ready to work - master automatically discovers workers by searching for instances in autoscaling group.

Here's the graph generated by terraform - I've removed provider.aws node for better readability.

![Terraform Graph](docs/graph.png)

# Prerequisites
HashiCorp Terraform

# Links
1. http://jmeter.apache.org/usermanual/remote-test.html
2. http://aws.amazon.com/
3. https://www.terraform.io/
4. http://jmeter.apache.org/